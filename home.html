<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>My Books</title>
</head>
<body>
  <h1 id="greeting">Loading...</h1>

  <form id="bookForm">
	<input name="title" placeholder="Title" required>
	<input name="author" placeholder="Author" required>
	<input name="genre" placeholder="Genre">
	<textarea name="comments" placeholder="Your comments..."></textarea>
	<button type="submit">Add Book</button>
  </form>

  <h2>Your Books</h2>
  <ul id="bookList"></ul>

  <script>
// =====================================================
// LOAD CURRENT USER NAME
// PHP keeps user data persistent across requests using sessions, which are stored server-side
// In add_book.php
  // Bind the parameters to the prepared statement:
  // - i = integer (user_id)
  // - s = string (title, author, genre, comments)
  /*
  	$stmt->bind_param(
	"issss", 
	$_SESSION['user_id'], 
	$data['title'], 
	$data['author'], 
	$data['genre'], 
	$data['comments']
	*/
// =====================================================
	async function loadUser() {
	  const res = await fetch("get_user.php");
	  const result = await res.json();

	  if (result.success) {
		document.getElementById("greeting").textContent = `${result.firstName}'s Book List`;
	  } else {
		alert(result.error);
		window.location = "index.html"; // redirect if not logged in
	  }
	}

	// Load books from the database and display them
	async function loadBooks() {
		
	// Get the current user's ID in get_books.php
	// $id = $_SESSION['user_id'];
	  const res = await fetch("get_books.php");
	  const books = await res.json();
	  const list = document.getElementById("bookList");
	  list.innerHTML = "";
	  console.log(books); // Add this line inside loadBooks()
	  books.forEach(book => {
		const li = document.createElement("li");
		li.textContent = `${book.title} by ${book.author} (${book.genre}) â€“ ${book.comments} `;

		const deleteBtn = document.createElement("button");
		deleteBtn.textContent = "Delete";
		deleteBtn.style.marginLeft = "10px";
		deleteBtn.onclick = async () => {
		  if (confirm(`Delete "${book.title}"?`)) {
			const res = await fetch("delete_book.php", {
			  method: "POST",
			  headers: { "Content-Type": "application/json" },
			  body: JSON.stringify({ id: book.id }) // Make sure `id` is included from get_books.php
			});
			const result = await res.json();
			if (result.success) {
			  loadBooks();
			} else {
			  alert(result.error);
			}
		  }
		};

		li.appendChild(deleteBtn);
		list.appendChild(li);
	  });
	}

	// Handle form submission to add a new book
	document.getElementById("bookForm").addEventListener("submit", async e => {
		
	  // e.target is the form element that triggers the submit event.
	  // Collect form data. new FormData(e.target) gathers: All <input>, <textarea>, <select> elements. 
	  // Their name attributes become keys
	  e.preventDefault();
	  const form = new FormData(e.target);
	  
	// form gives you
	// Key		Value
	// email		user@example.com
	// password	1234
		
		// Then FormData is something like
		/*
			fetch("login.php", {
			method: "POST",
			body: form
		});
		*/

	  const res = await fetch("add_book.php", {
		method: "POST",
		body: form
	  });

	  const result = await res.json();
	  if (result.success) {
		e.target.reset();
		loadBooks();
	  } else {
		alert(result.error);
	  }
	});

	// Initial load
	loadUser();
	loadBooks();
  </script>
</body>
</html>
