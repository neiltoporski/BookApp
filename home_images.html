<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>My Books</title>

  <style>
	body {
	  font-family: Arial, sans-serif;
	  padding: 20px;
	}

	#bookList {
	  display: flex;
	  flex-wrap: wrap;
	  gap: 20px;
	}

	.book-card {
	  width: 250px;
	  border: 1px solid #ccc;
	  border-radius: 10px;
	  padding: 15px;
	  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  text-align: center;
	  background-color: #fafafa;
	}

	.book-card img {
	  width: 100%;
	  height: auto;
	  max-height: 300px;
	  object-fit: contain;
	  margin-bottom: 10px;
	}

	.book-card h3 {
	  margin: 10px 0 5px;
	  font-size: 16px;
	}

	.book-card p {
	  margin: 5px 0;
	  font-size: 14px;
	}

	.book-card button {
	  margin-top: 10px;
	  padding: 6px 12px;
	  font-size: 14px;
	  background-color: #c62828;
	  color: white;
	  border: none;
	  border-radius: 5px;
	  cursor: pointer;
	}

	form {
	  margin-bottom: 30px;
	}

	form input, form textarea {
	  display: block;
	  margin-bottom: 10px;
	  padding: 8px;
	  width: 300px;
	  font-size: 14px;
	}

	form button {
	  padding: 10px 15px;
	  font-size: 14px;
	}
  </style>
</head>
<body>
  <h1 id="greeting">Add Book</h1>

  <form id="bookForm">
	<input name="title" placeholder="Title" required>
	<input name="author" placeholder="Author" required>
	<input name="genre" placeholder="Genre">
	<textarea name="comments" placeholder="Your comments..."></textarea>
	<button type="submit">Add Book</button>
  </form>

  <h2>Your Books</h2>
  <div id="bookList"></div>

  <script>
	async function loadUser() {
	  const res = await fetch("get_user.php");
	  const result = await res.json();

	  if (result.success) {
		document.getElementById("greeting").textContent = `${result.firstName}'s Book List`;
	  } else {
		alert(result.error);
		window.location = "index.html"; // redirect if not logged in
	  }
	}

	async function loadBooks() {
	  const res = await fetch("get_books.php");
	  const books = await res.json();
	  const list = document.getElementById("bookList");
	  list.innerHTML = "";

	  for (const book of books) {
		// Default placeholder
		let thumbnail = "https://via.placeholder.com/128x195?text=No+Cover";

		// Try to fetch from Google Books API
		try {
		  const query = encodeURIComponent(`${book.title} ${book.author}`);
		  const googleRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${query}`);
		  const googleData = await googleRes.json();
		  if (
			googleData.items &&
			googleData.items[0]?.volumeInfo?.imageLinks?.thumbnail
		  ) {
			thumbnail = googleData.items[0].volumeInfo.imageLinks.thumbnail;
		  }
		} catch (e) {
		  console.error("Google Books API error:", e);
		}

		// Create card
		const card = document.createElement("div");
		card.className = "book-card";
		card.innerHTML = `
		  <img src="${thumbnail}" alt="Cover for ${book.title}">
		  <h3>${book.title}</h3>
		  <p><strong>Author:</strong> ${book.author}</p>
		  <p><strong>Genre:</strong> ${book.genre || ''}</p>
		  <p><strong>Comments:</strong> ${book.comments || ''}</p>
		`;

		const deleteBtn = document.createElement("button");
		deleteBtn.textContent = "Delete";
		deleteBtn.onclick = async () => {
		  if (confirm(`Delete "${book.title}"?`)) {
			const res = await fetch("delete_book.php", {
			  method: "POST",
			  headers: { "Content-Type": "application/json" },
			  body: JSON.stringify({ id: book.id })
			});
			const result = await res.json();
			if (result.success) {
			  loadBooks();
			} else {
			  alert(result.error);
			}
		  }
		};

		card.appendChild(deleteBtn);
		list.appendChild(card);
	  }
	}

	// Submit handler for adding books
	document.getElementById("bookForm").addEventListener("submit", async e => {
	  e.preventDefault();
	  const form = new FormData(e.target);

	  const res = await fetch("add_book.php", {
		method: "POST",
		body: form
	  });

	  const result = await res.json();
	  if (result.success) {
		e.target.reset();
		loadBooks();
	  } else {
		alert(result.error);
	  }
	});

	// Initial load
	loadUser();
	loadBooks();
  </script>
</body>
</html>
